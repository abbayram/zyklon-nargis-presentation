<script>
    // --- SETUP & GLOBALS ---
    let currentSlide = 1; const totalSlides = 15;
    let canvas, ctx, evacCanvas, evacCtx, histCanvas, histCtx, blockadeCanvas, blockadeCtx;
    let waterParticles = [], debrisParticles = [], mangroveRoots = [], villagers = [];
    let isFlooding = false, mangrovesActive = true, villageDestroyed = false, isEvacuating = false;
    let time = 0; let timelineStep = 0;
    
    // Globals für Historische Timeline
    let histStep = 0; let histActorX = 0; let histTargetX = 0; let isHistAnimating = false;
    let histActorType = 'people'; let showUprising = false; let uprisingEliminated = false;
    let tankFiredTimer = 0; let chainBroken = false;

    // GLOBALS FÜR BLOCKADE ANIMATION
    let helpArrows = [];
    let isBlockadeAnimating = false;

    // --- AVATAR CONFIG ---
    const expertImages = ["./assets/avatars/expertin1.png", "./assets/avatars/expertin2.png", "./assets/avatars/expertin8.png"];
    const generalImages = ["./assets/avatars/general1.png", "./assets/avatars/general2.png", "./assets/avatars/general3.png"];

    let expertMouthOpen = false; let generalMouthOpen = false; let talkingInterval = null;

    // SVG Strings für Häuser
    const houseIntactSVG = `<svg viewBox="0 0 100 100" class="house-svg"><path d="M50 0 L100 40 L90 40 L90 100 L10 100 L10 40 L0 40 Z" fill="#8D6E63"/><rect x="35" y="60" width="30" height="40" fill="#5D4037"/></svg>`;
    const houseDestroyedSVG = `<svg viewBox="0 0 100 100" class="house-svg"><path d="M10 90 L30 70 L50 85 L70 60 L90 95 Z" fill="#5D4037"/><path d="M0 100 L20 80 L40 95 L60 70 L80 100 Z" fill="#3E2723" opacity="0.7"/></svg>`;


    // --- FUNKTIONEN (AVATARE & DIALOG) ---
    function setSpeakerImage(who, index) {
        let imgId = ''; let imageArray = [];
        if(who === 'expert') { imgId = 'expert-img'; imageArray = expertImages; }
        else if(who === 'general') { imgId = 'general-img'; imageArray = generalImages; }
        else { return; }
        const img = document.getElementById(imgId);
        if(img && typeof index === 'number' && imageArray[index]) { img.src = imageArray[index]; }
    }

    function startTalkingAnimation(who) {
        if(talkingInterval) clearInterval(talkingInterval);
        if(['expert','general'].indexOf(who) === -1) return;
        talkingInterval = setInterval(() => {
            if (who === 'expert') { expertMouthOpen = !expertMouthOpen; setSpeakerImage('expert', expertMouthOpen ? 1 : 0); } 
            else if (who === 'general') { generalMouthOpen = !generalMouthOpen; setSpeakerImage('general', generalMouthOpen ? 1 : 0); }
        }, 200); 
    }

    function stopTalkingAnimation() {
        if(talkingInterval) clearInterval(talkingInterval);
        talkingInterval = null;
        setSpeakerImage('expert', 0); expertMouthOpen = false;
        setSpeakerImage('general', 0); generalMouthOpen = false;
    }

    window.onload = function() {
        canvas = document.getElementById('flood-canvas'); ctx = canvas.getContext('2d');
        evacCanvas = document.getElementById('evacuation-canvas'); evacCtx = evacCanvas.getContext('2d');
        histCanvas = document.getElementById('hist-canvas'); histCtx = histCanvas.getContext('2d');
        blockadeCanvas = document.getElementById('blockade-canvas'); blockadeCtx = blockadeCanvas.getContext('2d');
        resizeAllCanvases();
        initSimulationEnhanced(); animateFloodLoopEnhanced(); initEvacuationScene();
        initHistCanvas(); 
        
        document.getElementById('dialog-bubble').style.display = 'none';
        stopTalkingAnimation();
        setSpeakerImage('expert', 0); setSpeakerImage('general', 0);
    };
    window.onresize = resizeAllCanvases;
    function resizeAllCanvases() {
         if(canvas) { canvas.width = canvas.parentElement.offsetWidth; canvas.height = 350; }
         if(evacCanvas) { evacCanvas.width = evacCanvas.parentElement.offsetWidth; evacCanvas.height = 350; initEvacuationScene(); }
         if(histCanvas) { histCanvas.width = histCanvas.parentElement.offsetWidth; histCanvas.height = 400; initHistCanvas(); }
         if(blockadeCanvas) { blockadeCanvas.width = blockadeCanvas.parentElement.offsetWidth; blockadeCanvas.height = 450; initBlockadeScene(); }
    }

    // --- NAVIGATION & NEUE LOGIK ---
    function showSlide(n) {
        document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
        document.getElementById(`slide${n}`).classList.add('active');
        
        // Generelles Ausblenden der Avatare zu Beginn jedes Slide-Wechsels
        ['expert', 'general'].forEach(c => document.getElementById(`char-${c}`).classList.remove('visible'));
        closeDialog();

        // SLIDE 2: Historie (KEINE EXPERTIN)
        if(n === 2) {
             initHistCanvas();
        }
        
        // SLIDE 3: Diagramm (KEINE EXPERTIN)
        if(n === 3) { 
            resetDiagram(); 
            document.getElementById('leitfrage-popup').classList.remove('visible'); 
        }
        
        // SLIDE 4: Nargis Timeline (General sichtbar, weil er zusieht)
        if(n === 4) { 
            document.getElementById('char-general').classList.add('visible');
            resetTimeline();
        }

        // SLIDE 6: Politische Analyse
        if(n === 6) { 
            // ÄNDERUNG: Expertin NICHT mehr manuell einblenden.
            // Sie kommt erst durch triggerDialog.
            setTimeout(() => triggerDialog('expert', 'Der Staat war auf Kontrolle ausgerichtet, nicht auf den Schutz seiner Bürger.'), 500); 
        }

        // SLIDE 7: Blockade
        if(n === 7) {
             document.getElementById('char-general').classList.add('visible');
             initBlockadeScene();
             setSpeakerImage('general', 2); 
             setTimeout(() => triggerDialog('general', 'Unsere Souveränität ist unantastbar. Diese "Hilfe" ist nur ein Vorwand für ausländische Einmischung.'), 500);
        }

        // SLIDE 8 & 10 (Keine Avatare)
        if(n === 8) { 
            // Avatare bleiben unsichtbar
            document.querySelectorAll('.analysis-point').forEach(p => p.classList.remove('visible'));
            setTimeout(() => { document.getElementById('eco-point-1').classList.add('visible'); }, 1000);
            setTimeout(() => { document.getElementById('eco-point-2').classList.add('visible'); }, 3000);
            setTimeout(() => { document.getElementById('eco-point-3').classList.add('visible'); }, 5000);
        }
        if(n === 10) {
            document.getElementById('env-point-1').classList.remove('visible');
            setTimeout(() => { document.getElementById('env-point-1').classList.add('visible'); }, 1000);
        }
        
        // SLIDE 12: Zerstörung
        if(n === 12) {
            initHouseGrid();
            // ÄNDERUNG: Expertin NICHT mehr manuell einblenden.
            // Sie erscheint erst am Ende der Animation (animateDestruction).
        }

        if(n === 15) { stopTalkingAnimation(); }
    }
    function nextSlide() { if(currentSlide < totalSlides) showSlide(++currentSlide); }
    function prevSlide() { if(currentSlide > 1) showSlide(--currentSlide); }

    function triggerDialog(who, text) {
        const bubble = document.getElementById('dialog-bubble');
        let displayName = '', bubbleClass = '';
        if(who === 'expert') { displayName = 'Expertin'; bubbleClass = 'bubble-pos-expert'; }
        else if(who === 'general') { displayName = 'General'; bubbleClass = 'bubble-pos-general'; }
        
        document.getElementById('dialog-text').innerHTML = `<strong>${displayName}:</strong><br>"${text}"`;
        bubble.className = "speech-bubble " + bubbleClass;
        bubble.style.display = 'block';
        
        // Hier wird der Avatar sichtbar gemacht, weil er spricht
        document.getElementById(`char-${who}`).classList.add('visible');
        startTalkingAnimation(who);
    }

    function closeDialog() { 
        document.getElementById('dialog-bubble').style.display = 'none'; 
        const current = document.querySelector('.slide.active').id;
        stopTalkingAnimation();

        // --- ÄNDERUNG: Expertin ausblenden, wenn Dialog geschlossen wird ---
        // Damit verschwindet expertin1.png/expertin2.png, wenn sie nichts mehr sagt.
        document.getElementById('char-expert').classList.remove('visible');
        // (Optional: General auch ausblenden, falls gewünscht. Hier lassen wir ihn drin, falls er nur zusieht)
        // document.getElementById('char-general').classList.remove('visible'); 

        // Weiterleitungslogik
        if(current === 'slide1') nextSlide(); 
    }

    // --- FUNKTIONEN FÜR DIAGRAMM ANIMATION (Slide 3) ---
    function animateDiagram() {
        document.getElementById('bar-mala').classList.add('mala-shrunk');
        setTimeout(() => {
             const nargisBar = document.getElementById('bar-nargis');
             nargisBar.classList.remove('nargis-placeholder');
             nargisBar.classList.add('nargis-grown');
             
             setTimeout(() => {
                 document.getElementById('leitfrage-popup').classList.add('visible');
             }, 1000);

        }, 1500);
    }
    function resetDiagram() {
        document.getElementById('bar-mala').classList.remove('mala-shrunk');
        const nargisBar = document.getElementById('bar-nargis');
        nargisBar.classList.remove('nargis-grown');
        nargisBar.classList.add('nargis-placeholder');
    }

    // ==========================================
    // --- TIMELINE LOGIK (Slide 4) ---
    // ==========================================
    function resetTimeline() {
        timelineStep = 0;
        ['tl-ev-1', 'tl-ev-2', 'tl-ev-3'].forEach(id => document.getElementById(id).classList.remove('active'));
        document.getElementById('timeline-status').innerText = "Verfolgen Sie die Ereignisse.";
        document.getElementById('timeline-btn').innerText = "Ereignis starten";
    }
    function advanceTimeline() {
        timelineStep++;
        const status = document.getElementById('timeline-status');
        const btn = document.getElementById('timeline-btn');
        if(timelineStep === 1) {
            document.getElementById('tl-ev-1').classList.add('active'); status.innerText = "Phase 1: Die ignorierte Warnung.";
             btn.innerText = "Weiter";
        } else if(timelineStep === 2) {
            document.getElementById('tl-ev-2').classList.add('active'); status.innerText = "Phase 2: Die Katastrophe trifft ein.";
        } else if(timelineStep === 3) {
            document.getElementById('tl-ev-3').classList.add('active'); status.innerText = "Phase 3: Politik über Menschenleben.";
            triggerDialog('general', 'Das Referendum ist entscheidend für die Stabilität. Ausländische Hilfe bringt nur Unruhe. Die Lage ist unter Kontrolle.'); btn.innerText = "Zu den Fakten";
        } else if(timelineStep > 3) { nextSlide(); }
    }

    // ==========================================
    // --- HISTORISCHE TIMELINE ANIMATION (Slide 2) ---
    // ==========================================
    function initHistCanvas() {
        histStep = 0; histActorX = histCanvas.width * 0.1; histTargetX = histActorX;
        isHistAnimating = false; histActorType = 'people'; showUprising = false; uprisingEliminated = false;
        tankFiredTimer = 0; chainBroken = false;
        drawHistFrame();
        // Reset Bilder
        ['img-1948', 'img-1962', 'img-1988', 'img-2008'].forEach(id => document.getElementById(id).classList.remove('visible'));
        document.getElementById('hist-btn').innerText = "Geschichte starten";
        document.getElementById('hist-status').innerText = "Klicken Sie, um die Geschichte zu starten.";
    }
    function updateHistAnimation() {
        if(tankFiredTimer > 0) tankFiredTimer--;
        if(histActorX < histTargetX) {
            histActorX += 3; 
            if(histActorX >= histTargetX) {
                histActorX = histTargetX;
                if(histStep === 2) { histActorType = 'tank'; 
                    document.getElementById('img-1962').classList.add('visible'); 
                }
                if(histStep === 3) { 
                    tankFiredTimer = 30; setTimeout(() => { uprisingEliminated = true; }, 500); isHistAnimating = false; 
                    document.getElementById('img-1988').classList.add('visible');
                    document.getElementById('hist-btn').innerText = "Weiter zu 2008"; 
                }
                if(histStep === 4) { 
                    histActorType = 'ballotbox'; 
                    document.getElementById('img-2008').classList.add('visible');
                    document.getElementById('hist-btn').innerText = "Zum Vergleich"; 
                }
            }
        }
    }
    function drawChain(x, y, broken) {
        histCtx.strokeStyle = '#555'; histCtx.lineWidth = 4;
        for(let i=0; i<5; i++) {
            let offsetX = 0; let offsetY = 0; let rotation = 0;
            if(broken) { offsetX = (i-2) * 15 * (Math.sin(time*0.05)+1); offsetY = Math.abs(i-2) * 10 * (Math.cos(time*0.05)+1); rotation = (i-2) * 0.5 * time*0.05; }
            histCtx.save(); histCtx.translate(x + i*15 + offsetX, y + offsetY); histCtx.rotate(rotation);
            histCtx.beginPath(); histCtx.ellipse(0, 0, 8, 4, 0, 0, Math.PI*2); histCtx.stroke(); histCtx.restore();
        }
    }
    function drawBalloons(x, y) {
        const colors = ['#FF5722', '#2196F3', '#FFC107', '#4CAF50'];
        for(let i=0; i<5; i++) {
            let rise = (time*0.5 + i*20) % 100; let wobble = Math.sin(time*0.1 + i);
            histCtx.fillStyle = colors[i%colors.length]; histCtx.beginPath(); histCtx.arc(x - 30 + i*15 + wobble, y - 50 - rise, 8, 0, Math.PI*2); histCtx.fill();
            histCtx.strokeStyle = '#ccc'; histCtx.lineWidth=1; histCtx.beginPath(); histCtx.moveTo(x - 30 + i*15 + wobble, y - 42 - rise); histCtx.lineTo(x - 30 + i*15 + wobble, y - 20 - rise); histCtx.stroke();
        }
    }
    function drawPeopleGroup(x, y, color, isJumping, isDead) {
        histCtx.fillStyle = isDead ? '#888' : color; histCtx.strokeStyle = isDead ? '#888' : color; histCtx.lineWidth = 2;
        for(let i=0; i<3; i++) {
            let jump = isJumping ? Math.sin(time*0.3 + i)*5 : 0; let scale = isDead ? 0.7 : 1; 
            histCtx.save(); histCtx.translate(x + i*20, y); histCtx.scale(scale, scale); histCtx.translate(-(x + i*20), -y);
            histCtx.beginPath(); histCtx.arc(x + i*20, y - 25 - jump, 6, 0, Math.PI*2); histCtx.fill();
            histCtx.beginPath(); histCtx.moveTo(x+i*20, y-20-jump); histCtx.lineTo(x+i*20, y-5-jump);
            histCtx.moveTo(x+i*20-5, y-15-jump); histCtx.lineTo(x+i*20+5, y-15-jump);
            histCtx.moveTo(x+i*20, y-5-jump); histCtx.lineTo(x+i*20-5, y-jump);
            histCtx.moveTo(x+i*20, y-5-jump); histCtx.lineTo(x+i*20+5, y-jump);
            histCtx.stroke(); histCtx.restore();
        }
    }
    function drawTankShape(x, y) {
        histCtx.fillStyle = '#3A421B'; histCtx.fillRect(x-30, y-25, 60, 20); histCtx.fillRect(x-15, y-35, 30, 10); histCtx.fillRect(x+10, y-32, 25, 4); 
        histCtx.fillStyle = '#1b1b1b'; histCtx.fillRect(x-35, y-5, 70, 8); histCtx.fillStyle = '#555'; for(let i=0;i<3;i++) { histCtx.beginPath(); histCtx.arc(x-20+i*20, y-1, 4,0,Math.PI*2); histCtx.fill();}
    }
    function drawTankFire(x, y) {
        if(tankFiredTimer > 0) { histCtx.fillStyle = 'orange'; histCtx.beginPath(); histCtx.arc(x+35, y-30, 15 + Math.random()*5, 0, Math.PI*2); histCtx.fill(); histCtx.fillStyle = 'yellow'; histCtx.beginPath(); histCtx.arc(x+35, y-30, 8 + Math.random()*3, 0, Math.PI*2); histCtx.fill(); }
    }
    function drawBallotBox(x, y) {
        histCtx.fillStyle = '#8B4513'; histCtx.fillRect(x-25, y-40, 50, 40); histCtx.fillStyle = '#222'; histCtx.fillRect(x-15, y-45, 30, 5); histCtx.fillStyle = '#fff'; histCtx.fillRect(x-10, y-35, 20, 20); 
        histCtx.strokeStyle = 'var(--myanmar-red)'; histCtx.lineWidth=3; histCtx.beginPath(); histCtx.moveTo(x-5,y-25); histCtx.lineTo(x,y-20); histCtx.lineTo(x+10,y-30); histCtx.stroke(); 
    }
    function drawConfetti(x, y) {
         histCtx.fillStyle = '#FFD700'; for(let i=0;i<15;i++) histCtx.fillRect(x-30+Math.random()*60, y-50+Math.random()*40, 4, 4);
         histCtx.fillStyle = '#FF5722'; for(let i=0;i<10;i++) histCtx.fillRect(x-30+Math.random()*60, y-50+Math.random()*40, 3, 3);
    }
    function drawCycloneShape(x, y) {
        histCtx.strokeStyle = 'rgba(50,50,50,0.6)'; histCtx.lineWidth = 4; histCtx.beginPath();
        for(let i=0; i<4; i++) { histCtx.arc(x, y-40, 10+i*8, time*0.1+i, time*0.1+i+Math.PI*1.5); }
        histCtx.stroke();
    }
    function drawHistFrame() {
        histCtx.clearRect(0, 0, histCanvas.width, histCanvas.height); let groundY = histCanvas.height * 0.65;
        if(histStep >= 1) drawChain(histCanvas.width * 0.1, groundY - 60, chainBroken);
        if(histStep >= 1 && chainBroken && histActorType === 'people') { drawConfetti(histCanvas.width * 0.1, groundY); drawBalloons(histCanvas.width * 0.1, groundY - 20); }
        if(histStep >= 3 && showUprising) drawPeopleGroup(histCanvas.width * 0.6, groundY, '#D32F2F', !uprisingEliminated, uprisingEliminated);
        if(histStep === 4 && histActorType === 'ballotbox') drawCycloneShape(histCanvas.width * 0.9, groundY);
        if(histActorType === 'people') { drawPeopleGroup(histActorX, groundY, '#4CAF50', isHistAnimating && histActorX < histTargetX, false); } 
        else if (histActorType === 'tank') { drawTankShape(histActorX, groundY); drawTankFire(histActorX, groundY); } 
        else if (histActorType === 'ballotbox') { drawBallotBox(histActorX, groundY); }
    }
    function animateHistLoop() { updateHistAnimation(); drawHistFrame(); if(currentSlide === 2) requestAnimationFrame(animateHistLoop); }
    function advanceHistory() {
        histStep++; const status = document.getElementById('hist-status'); const btn = document.getElementById('hist-btn');
        if(histStep === 1) { 
            chainBroken = true; isHistAnimating = true; animateHistLoop(); 
            status.innerText = "1948: Unabhängigkeit! Doch die Freude währt kurz."; btn.innerText = "Aufbruch nach 1962"; 
            document.getElementById('img-1948').classList.add('visible'); 
        } 
        else if(histStep === 2) { 
            histTargetX = histCanvas.width * 0.35; isHistAnimating = true; 
            status.innerText = "1962: Der Putsch beendet die Demokratie."; btn.innerText = "Weiter zum Aufstand (1988)"; 
            document.getElementById('img-1962').classList.add('visible');
        } 
        else if(histStep === 3) { 
            histTargetX = histCanvas.width * 0.6; showUprising = true; isHistAnimating = true; 
            status.innerText = "1988: Volksaufstand wird niedergeschlagen."; 
            document.getElementById('img-1988').classList.add('visible');
        } 
        else if(histStep === 4) { 
            histTargetX = histCanvas.width * 0.9; isHistAnimating = true; 
            status.innerText = "2008: Eine isolierte Militärdiktatur trifft auf einen Zyklon."; 
            document.getElementById('img-2008').classList.add('visible');
        } 
        else if(histStep > 4) { nextSlide(); }
    }

    // ==========================================
    // --- BLOCKADE ANIMATION (Slide 7) ---
    // ==========================================
    class HelpArrow {
        constructor(side) {
            this.side = side; // 'left', 'bottom', 'right'
            this.reset();
        }
        reset() {
            this.speed = Math.random() * 2 + 2;
            this.blocked = false; this.blockedTimer = 0;
            if(this.side === 'left') { this.x = -50; this.y = Math.random() * blockadeCanvas.height; this.vx = this.speed; this.vy = (blockadeCanvas.height/2 - this.y) * 0.01; }
            if(this.side === 'bottom') { this.x = Math.random() * blockadeCanvas.width; this.y = blockadeCanvas.height + 50; this.vx = (blockadeCanvas.width/2 - this.x) * 0.01; this.vy = -this.speed; }
            if(this.side === 'right') { this.x = blockadeCanvas.width + 50; this.y = Math.random() * blockadeCanvas.height; this.vx = -this.speed; this.vy = (blockadeCanvas.height/2 - this.y) * 0.01; }
        }
        update() {
            if(this.blocked) { this.blockedTimer++; if(this.blockedTimer > 20) this.reset(); return; }
            this.x += this.vx; this.y += this.vy;
            let centerX = blockadeCanvas.width/2; let centerY = blockadeCanvas.height/2;
            if(this.x > centerX - 80 && this.x < centerX + 80 && this.y > centerY - 150 && this.y < centerY + 150) {
                this.blocked = true;
            }
        }
        draw() {
            blockadeCtx.fillStyle = this.blocked ? 'red' : '#2196F3';
            blockadeCtx.save(); blockadeCtx.translate(this.x, this.y); blockadeCtx.rotate(Math.atan2(this.vy, this.vx));
            blockadeCtx.beginPath(); blockadeCtx.moveTo(-10, -5); blockadeCtx.lineTo(0, -5); blockadeCtx.lineTo(0, -10); blockadeCtx.lineTo(15, 0); blockadeCtx.lineTo(0, 10); blockadeCtx.lineTo(0, 5); blockadeCtx.lineTo(-10, 5); blockadeCtx.fill();
            blockadeCtx.restore();
            if(this.blocked) { blockadeCtx.strokeStyle = 'red'; blockadeCtx.lineWidth = 3; blockadeCtx.beginPath(); blockadeCtx.moveTo(this.x-10, this.y-10); blockadeCtx.lineTo(this.x+10, this.y+10); blockadeCtx.moveTo(this.x+10, this.y-10); blockadeCtx.lineTo(this.x-10, this.y+10); blockadeCtx.stroke(); }
        }
    }

    function initBlockadeScene() {
        isBlockadeAnimating = false; helpArrows = [];
        for(let i=0; i<5; i++) helpArrows.push(new HelpArrow('left'));
        for(let i=0; i<5; i++) helpArrows.push(new HelpArrow('bottom'));
        for(let i=0; i<5; i++) helpArrows.push(new HelpArrow('right'));
        drawBlockadeFrame();
    }
    function drawBlockadeFrame() {
        blockadeCtx.clearRect(0, 0, blockadeCanvas.width, blockadeCanvas.height);
        helpArrows.forEach(a => a.draw());
    }
    function animateBlockadeLoop() {
        if(!isBlockadeAnimating) return;
        helpArrows.forEach(a => a.update());
        drawBlockadeFrame();
        requestAnimationFrame(animateBlockadeLoop);
    }
    function startBlockadeAnimation() {
        if(isBlockadeAnimating) return;
        isBlockadeAnimating = true;
        triggerDialog('general', 'Sehen Sie die roten Kreuze? Das sind Hilfslieferungen, die wir abweisen. Unsere Souveränität ist wichtiger.');
        animateBlockadeLoop();
    }


    // ==========================================
    // --- SIMULATIONEN (Slides 9 & 11) ---
    // ==========================================
    class WaterParticle {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * -150; this.yBase = Math.random() * (canvas.height - 60) + 30;
            this.y = this.yBase; this.vx = Math.random() * 4 + 3; this.size = Math.random() * 8 + 5; 
            this.waveOffset = Math.random() * Math.PI * 2; this.isMuddy = false;
        }
        update() {
            this.y = this.yBase + Math.sin(time * 0.05 + this.waveOffset) * 5;
            if (mangrovesActive && this.x > canvas.width*0.28 && this.x < canvas.width*0.45) this.vx *= 0.9;
            this.x += this.vx;
            if(!mangrovesActive && this.x > canvas.width*0.25) {
                this.isMuddy = true;
                if(this.x > canvas.width * 0.62 && !villageDestroyed) destroyVillage();
            }
            if(this.x > canvas.width + 50) this.reset();
        }
        draw() {
            const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
            if(this.isMuddy) { grad.addColorStop(0, 'rgba(121, 85, 72, 0.8)'); grad.addColorStop(1, 'rgba(93, 64, 55, 0.1)'); } 
            else { grad.addColorStop(0, 'rgba(79, 195, 247, 0.8)'); grad.addColorStop(1, 'rgba(2, 136, 209, 0.1)'); }
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
        }
    }
    function initMangroves() {
        mangroveRoots = [];
        for(let i=0; i<25; i++) {
           let startX = canvas.width * 0.3 + (i * 10); let startY = canvas.height - 80;
           let path = new Path2D(); path.moveTo(startX, startY);
           path.bezierCurveTo(startX - 10, startY + 30, startX + 15, startY + 50, startX + 5, canvas.height - 10);
           mangroveRoots.push({ path: path, x: startX, y: startY, offset: Math.random() });
        }
    }
    function drawRealisticMangroves() {
        if (!mangrovesActive) return;
        ctx.save(); ctx.strokeStyle = '#33691e'; ctx.lineWidth = 4; ctx.lineCap = 'round';
        const sway = Math.sin(time * 0.02) * 3; 
        mangroveRoots.forEach(root => {
            ctx.save(); ctx.translate(root.x, root.y); ctx.rotate((sway + root.offset) * 0.02 * Math.PI); 
            ctx.translate(-root.x, -root.y); ctx.stroke(root.path); ctx.restore();
            ctx.fillStyle = '#558b2f'; ctx.beginPath(); ctx.arc(root.x + sway, root.y - 10, 12, 0, Math.PI*2); ctx.fill();
        });
        ctx.restore();
        ctx.fillStyle = '#1b5e20'; ctx.font = "bold 16px Arial"; ctx.fillText("MANGROVEN SCHUTZ", canvas.width*0.28, 60);
    }
    class DebrisParticle {
        constructor(x, y) {
            this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 10; this.vy = Math.random() * -15;
            this.gravity = 0.8; this.rotation = Math.random() * Math.PI; this.rSpeed = (Math.random() - 0.5) * 0.2;
            this.width = Math.random() * 20 + 10; this.height = Math.random() * 8 + 4;
            this.color = Math.random() > 0.5 ? '#8D6E63' : '#5D4037';
        }
        update() {
            this.vy += this.gravity; this.x += this.vx; this.y += this.vy; this.rotation += this.rSpeed;
            if(this.y > canvas.height - 20) { this.y = canvas.height - 20; this.vy *= -0.3; this.vx *= 0.8; }
        }
        draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation); ctx.fillStyle = this.color; ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height); ctx.restore(); }
    }
    function destroyVillage() {
        villageDestroyed = true;
        const villageX = canvas.width * 0.65; const groundY = canvas.height - 10;
        for(let i=0; i<3; i++) { let hx = villageX + (i * 70) + 20; let hy = groundY - 30; for(let k=0; k<15; k++) debrisParticles.push(new DebrisParticle(hx, hy)); }
    }
    function drawEnhancedVillage() {
        const villageX = canvas.width * 0.65; const groundY = canvas.height - 10;
        if(!villageDestroyed) {
            for(let i=0; i<3; i++) {
                let hx = villageX + (i * 70); let hy = groundY - 50;
                ctx.fillStyle = '#a1887f'; ctx.fillRect(hx, hy, 50, 50); ctx.fillStyle = '#4e342e'; ctx.fillRect(hx+15, hy+25, 20, 25);
                ctx.beginPath(); ctx.moveTo(hx-10, hy); ctx.lineTo(hx+25, hy-35); ctx.lineTo(hx+60, hy); ctx.fillStyle = '#795548'; ctx.fill();
            }
             ctx.fillStyle = '#333'; ctx.font = "bold 14px Arial"; ctx.fillText("Dorf (Ungeschützt)", villageX, groundY - 80);
        } else { ctx.fillStyle = '#8B0000'; ctx.font = "bold 14px Arial"; ctx.fillText("DORF ZERSTÖRT", villageX, groundY - 80); }
    }
    function initSimulationEnhanced() { waterParticles = []; debrisParticles = []; for(let i=0; i<250; i++) waterParticles.push(new WaterParticle()); initMangroves(); }
    function animateFloodLoopEnhanced() {
        ctx.clearRect(0,0,canvas.width,canvas.height); time++; 
        drawRealisticMangroves(); drawEnhancedVillage();
        if(villageDestroyed) debrisParticles.forEach(d => { d.update(); d.draw(); });
        if(isFlooding) { ctx.globalCompositeOperation = 'lighter'; waterParticles.forEach(p => { p.update(); p.draw(); }); ctx.globalCompositeOperation = 'source-over'; }
        requestAnimationFrame(animateFloodLoopEnhanced);
    }
    function toggleMangroves() {
        mangrovesActive = !mangrovesActive;
        const btn = document.getElementById('btn-mangroves');
        btn.innerText = mangrovesActive ? "Mangroven: INTAKT" : "Mangroven: ZERSTÖRT";
        btn.style.background = mangrovesActive ? "#2e7d32" : "#8B0000";
    }
    function startFlood() { 
        isFlooding = true; stopTalkingAnimation(); 
    }
    function resetFlood() { isFlooding = false; villageDestroyed = false; initSimulationEnhanced(); stopTalkingAnimation(); }

    // Evacuation Sim
    class Villager {
        constructor(x, y) {
            this.x = x; this.y = y; this.targetX = evacCanvas.width + 50; this.speed = Math.random() * 2 + 1.5;
            this.color = Math.random() > 0.5 ? '#333' : '#555';
        }
        update() { if(isEvacuating) this.x += this.speed; }
        draw() {
            evacCtx.fillStyle = this.color; evacCtx.strokeStyle = this.color; evacCtx.lineWidth = 2;
            evacCtx.beginPath(); evacCtx.arc(this.x, this.y - 20, 5, 0, Math.PI*2); evacCtx.fill();
            evacCtx.beginPath(); evacCtx.moveTo(this.x, this.y - 15); evacCtx.lineTo(this.x, this.y - 5);
            evacCtx.moveTo(this.x, this.y-5); evacCtx.lineTo(this.x-5 + Math.sin(time*0.2)*5, this.y);
            evacCtx.moveTo(this.x, this.y-5); evacCtx.lineTo(this.x+5 - Math.sin(time*0.2)*5, this.y);
            evacCtx.stroke();
        }
    }
    function initEvacuationScene() {
        villagers = []; isEvacuating = false;
        const startX = 100; const groundY = evacCanvas.height - 20;
        for(let i=0; i<5; i++) {
            let hx = startX + (i * 150);
            for(let k=0; k<3; k++) villagers.push(new Villager(hx + Math.random()*40, groundY));
        }
    }
    function drawEvacuationBg() {
        const startX = 100; const groundY = evacCanvas.height - 20;
        for(let i=0; i<5; i++) {
            let hx = startX + (i * 150); let hy = groundY - 60;
            evacCtx.fillStyle = '#795548'; evacCtx.fillRect(hx, hy, 60, 60);
            evacCtx.beginPath(); evacCtx.moveTo(hx-10, hy); evacCtx.lineTo(hx+30, hy-40); evacCtx.lineTo(hx+70, hy); evacCtx.fillStyle = '#5D4037'; evacCtx.fill();
        }
        evacCtx.fillStyle = 'rgba(46, 125, 50, 0.3)'; evacCtx.fillRect(evacCanvas.width - 100, 0, 100, evacCanvas.height);
        evacCtx.fillStyle = '#1b5e20'; evacCtx.font = "bold 16px Arial"; evacCtx.fillText("SICHERE ZONE", evacCanvas.width - 90, 50);
    }
    function animateEvacuationLoop() {
        evacCtx.clearRect(0,0,evacCanvas.width,evacCanvas.height);
        drawEvacuationBg();
        villagers.forEach(v => { v.update(); v.draw(); });
        if(isEvacuating) requestAnimationFrame(animateEvacuationLoop);
    }
    function startEvacuationDemo() {
        if(isEvacuating) return; initEvacuationScene(); isEvacuating = true; animateEvacuationLoop();
    }

    // --- NEU: FUNKTIONEN FÜR HOUSE GRID ANIMATION (Slide 12) ---
    function initHouseGrid() {
        const grid = document.getElementById('house-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 100; i++) {
            const houseCell = document.createElement('div');
            houseCell.className = 'house-cell';
            // Füge das intakte Haus SVG ein
            houseCell.innerHTML = houseIntactSVG;
            grid.appendChild(houseCell);
        }
    }

    function animateDestruction() {
        const houseCells = document.querySelectorAll('.house-cell');
        const survivorIndex = 99; // Das letzte Haus (Index 99 bei 100 Häusern) überlebt
        
        houseCells.forEach((cell, index) => {
            if (index !== survivorIndex) {
                setTimeout(() => {
                    // Ersetze das SVG und füge die Zerstörungsklasse hinzu
                    cell.innerHTML = houseDestroyedSVG;
                    cell.classList.add('is-destroyed');
                }, index * 10); // Etwas schnellere Animation für alle
            } else {
                 // Das überlebende Haus hervorheben
                 cell.classList.add('survivor');
            }
        });
        setTimeout(() => {
             triggerDialog('expert', 'Das ist die Realität. Von 100 Häusern im Delta blieben oft nur ein oder zwei stehen. Die Zerstörung war total.');
        }, 1500);
    }

    // --- BUDGET (NEU MIT SCHLECHTEN OPTIONEN - NEUTRAL) ---
    function updateBudget() {
        let total = 0;
        let good = 0;
        let bad = 0;

        document.querySelectorAll('.budget-input').forEach(i => {
            let val = parseInt(i.value);
            total += val;
            i.nextElementSibling.innerText = val;
            if(i.classList.contains('budget-good')) good += val;
            if(i.classList.contains('budget-bad')) bad += val;
        });

        document.getElementById('total-points').innerText = total;
        // Die genaue Aufschlüsselung wird im HTML versteckt, aber hier berechnet
        document.getElementById('good-points').innerText = good;
        document.getElementById('bad-points').innerText = bad;
        document.getElementById('total-points').style.color = total > 10 ? "red" : "black";
    }

    function checkBudget() {
        let total = parseInt(document.getElementById('total-points').innerText);
        let good = parseInt(document.getElementById('good-points').innerText);
        let bad = parseInt(document.getElementById('bad-points').innerText);

        if(total > 10) {
            alert("Budget überschritten! Sie haben nicht mehr als 10 Punkte.");
        } else if (bad > 3) {
            alert("Prioritäten falsch gesetzt! Sie haben zu viel in Kontrolle und Propaganda investiert, statt in den Schutz der Menschen. Die Katastrophe wird verheerend sein.");
        } else if (good < 5) {
             alert("Zu wenig in echten Schutz investiert! Frühwarnsysteme und Schutzbauten sind unzureichend. Das Risiko bleibt extrem hoch.");
        } else {
            alert("Gute Verteilung! Sie haben den Fokus auf Schutz und Vorsorge gelegt und die Prioritäten der Junta ignoriert. Sie haben viele Leben gerettet.");
            nextSlide();
        }
    }
</script>
